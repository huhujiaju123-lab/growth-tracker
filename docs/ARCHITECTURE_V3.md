# 成长记录与育儿决策支持系统 - 架构 V3

基于 2026-01-15 至 2026-01-16 的讨论整合

---

## 系统目标

```
记录成长 → 追踪变化 → 分析原因 → 给出行动建议 → 追踪问题进展 → 形成个人育儿智慧
```

---

## 三个核心角色

| 角色 | 核心职责 | 工作方式 |
|------|---------|---------|
| **记录者** | 记录事实、整理归档、追踪变化 | 每天自动工作 |
| **专家** | 给专业分析、有观点、可讨论 | 每天自动 + 可追问 |
| **导师** | 管理育儿问题清单、追踪思考进展 | 识别 + 追踪 + 提醒 |

---

## 角色 1：记录者（Recorder）

### 职责
- 把用户的日志整理成结构化的成长档案
- 追踪变化、发现趋势
- **纯记录，不加判断**

### 输出内容
- 事件分类（情绪/语言/运动/社交/睡眠/饮食等）
- 可观测的行为描述
- 标签（便于检索）
- 变化信号（对比历史）
- 触发条件
- 家长采取的应对

### 不做什么
- 不给建议
- 不做价值判断
- 不解读原因

### 输出格式
```json
{
  "oneLine": "一句话摘要",
  "events": [
    {
      "type": "sleep",
      "behavior": "夜醒2次，每次约15分钟",
      "trigger": "白天午睡超过2小时",
      "parentResponse": "陪伴安抚，未开灯",
      "frequency": "本周第3次",
      "intensity": "中等（哭泣但可安抚）"
    }
  ],
  "tags": ["睡眠", "夜醒", "午睡过长"],
  "changeSignals": [
    {
      "type": "frequency_increase",
      "description": "夜醒频率较上周增加",
      "comparison": "上周1次 → 本周3次"
    }
  ]
}
```

---

## 角色 2：专家（Expert）

### 职责
- 基于科学给出专业分析和建议
- **有观点，有依据，可讨论**
- 领域：脑科学、发育心理学、营养学、运动发展、情绪发展、教育学

### 每日自动分析内容

| 内容 | 说明 | 必须 |
|------|------|------|
| 发育领域识别 | 这是什么领域在发展（语言/运动/情绪...） | ✅ |
| 当前阶段解读 | 这个年龄段出现这个正常吗 | ✅ |
| 背后原因分析 | 为什么会这样 | ✅ |
| 建议 | 行动建议 + 风险提示（有就给，没有不硬给） | ✅ |
| 关联历史 | 和之前的记录对比，有什么变化/进步/退步 | ✅ 重要 |

### 风格设定

**当前风格：平衡派**

```
[发育领域] 这是语言爆发期的典型表现。

[为什么] 大脑的语言区在这个阶段快速发育，孩子会突然冒出很多新词。

[建议] 你可以：
1. 多和孩子对话，不用刻意纠正发音
2. 读绘本时指着图说对应的词

[关联] 和1月10日对比，词汇量明显增加了。

想了解更多可以继续问我。
```

**未来可配置方向**：
- 更学术（引用研究、理论）
- 更简洁（直接给结论和行动）
- 更详细（每个点展开讲）

### 讨论模式

- **开放、随意**：用户怎么问都行
- 可以追问、质疑、求解释、求建议
- 专家会回应、补充、讨论

### 知识边界处理

当专家不确定或不知道时：
1. **承认不知道**：「这个问题我不太确定」
2. **给出方向**：「但据我了解，可能的方向是...」
3. **标注不确定**：「这个说法我没有把握，建议你再查证」
4. **建议求助**：「如果持续困扰，建议咨询专业医生/心理师」

### 输出格式
```json
{
  "domain": "睡眠",
  "developmentArea": "睡眠调节能力发展",
  "stageInterpretation": "2岁左右出现睡眠倒退是常见现象，与大脑发育和分离焦虑有关",
  "causeAnalysis": "根据近2周记录，孩子的夜醒与午睡时长相关性较高",
  "suggestions": [
    {
      "action": "控制午睡时长在1.5小时内",
      "why": "过长午睡会减少夜间睡眠压力，导致入睡困难或夜醒",
      "how": "设置闹钟，午睡1.5小时后轻柔唤醒",
      "riskNote": null
    }
  ],
  "historicalComparison": {
    "reference": "1月10日记录",
    "observation": "夜醒频率从每周1次增加到3次",
    "trend": "increase"
  },
  "uncertaintyNote": null
}
```

### 不做什么
- 不替用户做价值观选择
- 不给没有依据的跟风结论
- 不假装知道不知道的事

---

## 角色 3：导师（Mentor）

### 职责
- 管理用户的「育儿问题清单」
- 长期追踪问题的思考和实践进展
- 帮用户保持在育儿的主航线上

### 核心功能

#### 1. 记录问题
- **来源 A**：用户主动添加（「我有个问题...」）
- **来源 B**：从日志中识别（「看起来你在困惑...」）

#### 2. 记录观察/思考
- **来源 A**：用户自己写的观察和思考
- **来源 B**：专家建议用户认可后，帮忙记录

#### 3. 追踪进展（三阶段）

| 阶段 | 状态 | 说明 |
|------|------|------|
| 观察期 | 🔴 | 刚识别出问题，还在收集信息和观察 |
| 实验期 | 🟡 | 有了一些想法，正在尝试和验证 |
| 内化期 | 🟢 | 形成了稳定的应对方式，已成为习惯 |

**阶段流转**：由系统自动判断
- 观察期 → 实验期：当有 3+ 条观察记录，且用户开始记录「尝试」类内容
- 实验期 → 内化期：当尝试持续 2+ 周无新问题，或用户明确标记「已解决」

#### 4. 每日检查
- 今天的日志是否回答了某个老问题？
- 今天是否产生了新问题？
- 提醒用户关注

#### 5. 主航线视角
- 定期回顾：你关注的核心问题是什么？
- 进展总结：哪些问题有进展，哪些还在困扰

### 问题清单结构

```json
{
  "id": "问题ID",
  "question": "具体的育儿问题",
  "stage": "observing | experimenting | internalized",
  "currentConclusion": "当前的结论/应对方式（AI建议，用户确认）",
  "observations": [
    {
      "date": "2026-01-15",
      "content": "观察内容",
      "source": "entry | manual",
      "entryId": "关联的日志ID（如有）"
    }
  ],
  "relatedEntryIds": ["关联的日志ID列表"],
  "createdAt": "创建时间",
  "lastUpdated": "最后更新时间"
}
```

### 不做什么
- 不强加价值观
- 不替用户做决定
- 不催促用户「解决」问题（有些问题需要时间）

---

## 界面布局

### 整体结构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        问题清单区（20%）                            │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐                       │
│  │问题1 │ │问题2 │ │问题3 │ │问题4 │ │问题5 │  [展开更多 ▼]         │
│  │ 🔴   │ │ 🟡   │ │ 🟢   │ │ 🔴   │ │ 🟡   │                       │
│  └──────┘ └──────┘ └──────┘ └──────┘ └──────┘                       │
│  [攻克中] [已内化]                                                   │
├─────────────────────────────────────────────────────────────────────┤
│                       主内容区（80%）                                │
│  ┌──────────────────┬──────────────────────────────────────────┐   │
│  │   日志记录区      │           专家讨论区                      │   │
│  │   （较窄）        │           （较宽）                        │   │
│  │                  │                                          │   │
│  │  [输入框]        │        对话历史                           │   │
│  │                  │                                          │   │
│  │  历史日志列表     │        ...                               │   │
│  │  · 1月15日       │                                          │   │
│  │  · 1月14日       │        [输入框]                          │   │
│  │  · 1月13日       │                                          │   │
│  └──────────────────┴──────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### 问题清单区规则

1. **卡片展示**：一行展示 5 个卡片，超出折叠
2. **展开/收起**：点击「展开更多」显示全部
3. **拖动排序**：支持拖动调整卡片顺序
4. **筛选标签**：
   - 「攻克中」：显示 🔴观察期 + 🟡实验期
   - 「已内化」：显示 🟢内化期
5. **卡片样式**：均匀分布，视觉一致

### 问题详情视图

点击问题卡片后，主内容区（80%）**替换**为问题详情视图：

```
┌─────────────────────────────────────────────────────────────────────┐
│                        问题清单区（20%）                            │
│  [当前选中: 问题1 - 孩子夜醒频繁怎么办？]                            │
├─────────────────────────────────────────────────────────────────────┤
│                       问题详情区（80%）                              │
│  ┌──────────────────┬──────────────────────────────────────────┐   │
│  │   观察记录区      │           讨论与结论区                    │   │
│  │   （较窄）        │           （较宽）                        │   │
│  │                  │                                          │   │
│  │  [新观察输入框]   │   当前结论                               │   │
│  │                  │   ┌────────────────────────────────┐     │   │
│  │  观察时间线       │   │ AI建议的结论...                │     │   │
│  │  · 1月15日 观察1  │   │ [采纳] [修改]                  │     │   │
│  │  · 1月14日 观察2  │   └────────────────────────────────┘     │   │
│  │  · 1月13日 观察3  │                                          │   │
│  │                  │   讨论历史                               │   │
│  │                  │   · 用户：为什么会夜醒？                  │   │
│  │                  │   · 专家：根据记录分析...                 │   │
│  │                  │                                          │   │
│  │                  │   [输入框 - 继续讨论]                     │   │
│  └──────────────────┴──────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### 当前结论交互

1. **AI 建议**：基于历史观察和讨论，AI 给出建议的结论
2. **用户确认**：用户可以：
   - 「采纳」：直接使用 AI 建议
   - 「修改」：编辑后保存为自己的版本
3. **版本记录**：保留结论的修改历史

---

## 数据模型

### 现有模型（保留）

- Entry（原始日志）
- FactCard（结构化事实卡）
- ExpertAnalysis（专家分析）
- ValuesPrinciple（价值观原则）
- Conversation（对话）
- Message（消息）
- ChildProfile（孩子档案）

### 新增：ParentingQuestion（育儿问题）

```prisma
model ParentingQuestion {
  id                String   @id @default(cuid())

  question          String   // 问题描述
  stage             String   @default("observing") // observing | experimenting | internalized
  currentConclusion String?  // 当前结论
  conclusionSource  String?  // ai | user | ai_modified

  displayOrder      Int      @default(0) // 显示顺序（支持拖动）

  relatedEntryIds   String[] // 关联的日志ID

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  observations      QuestionObservation[]
  discussions       QuestionDiscussion[]
}
```

### 新增：QuestionObservation（问题观察）

```prisma
model QuestionObservation {
  id          String   @id @default(cuid())
  questionId  String
  question    ParentingQuestion @relation(fields: [questionId], references: [id])

  content     String   // 观察内容
  source      String   // entry | manual
  entryId     String?  // 关联的日志ID（如有）

  createdAt   DateTime @default(now())
}
```

### 新增：QuestionDiscussion（问题讨论）

```prisma
model QuestionDiscussion {
  id          String   @id @default(cuid())
  questionId  String
  question    ParentingQuestion @relation(fields: [questionId], references: [id])

  role        String   // user | assistant
  content     String

  createdAt   DateTime @default(now())
}
```

---

## Prompt 文件结构

采用本地文件管理，便于调试：

```
/prompts
  ├── recorder.md      # 记录者 prompt
  ├── expert.md        # 专家 prompt
  ├── mentor.md        # 导师 prompt
  └── chat.md          # 综合对话 prompt
```

### Prompt 加载机制

```typescript
// 从本地文件读取 prompt
async function loadPrompt(agentName: string): Promise<string> {
  const filePath = path.join(process.cwd(), 'prompts', `${agentName}.md`)
  return fs.readFile(filePath, 'utf-8')
}
```

---

## 完整流程

### 流程 1：日志记录

```
用户输入日志
    ↓
┌─────────────────────────────────────────┐
│ Recorder Agent（记录者）                 │
│ - 结构化记录                            │
│ - 提取行为、触发条件、应对方式           │
│ - 检测变化信号（对比历史）               │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│ Expert Agent（专家）                     │
│ - 识别发育领域                          │
│ - 解读当前阶段                          │
│ - 分析原因                              │
│ - 给出建议                              │
│ - 关联历史记录                          │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│ Mentor Agent（导师）[后台检查]           │
│ - 检查是否与现有问题相关                 │
│ - 识别是否有新问题                       │
│ - 更新问题阶段                          │
└─────────────────────────────────────────┘
    ↓
存储 + 展示给用户
```

### 流程 2：问题追踪

```
用户点击问题卡片
    ↓
加载问题详情（观察列表、讨论历史、当前结论）
    ↓
用户可以：
  A. 添加新观察 → 更新观察列表
  B. 发起讨论 → 专家回复 → 更新结论建议
  C. 确认/修改结论 → 保存
    ↓
系统自动判断是否需要更新阶段
```

### 流程 3：自由讨论

```
用户在专家讨论区发起提问
    ↓
系统检索相关上下文：
  - 最近记录
  - 相关问题
  - 价值观原则
    ↓
专家回复（基于上下文）
    ↓
如识别到新问题 → 提示「是否添加到问题清单？」
```

---

## 技术栈

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| 前端 | Next.js 14 + React 18 | 全栈框架 |
| 样式 | TailwindCSS | 原子化 CSS |
| 数据库 | PostgreSQL + pgvector | Supabase |
| ORM | Prisma | 类型安全 |
| LLM | OpenAI GPT-4o | Agent 驱动 |
| 部署 | Vercel | 免费层 |

---

## 更新记录

| 日期 | 版本 | 更新内容 |
|------|------|----------|
| 2026-01-15 | V1 | 初版：基础 Agent 系统 |
| 2026-01-15 | V2 | 三层分析、价值观对齐 |
| 2026-01-16 | V3 | 重新定义导师角色、新增问题追踪、UI 布局设计 |

---

## 待实现

### Phase 1（当前）
- [ ] 新 UI 布局实现
- [ ] 问题清单功能
- [ ] 问题详情视图
- [ ] Prompt 本地文件管理

### Phase 2
- [ ] 阶段自动流转逻辑
- [ ] 向量语义检索
- [ ] 周/月摘要

### Phase 3
- [ ] 多孩子支持
- [ ] 数据导出
- [ ] 移动端适配

