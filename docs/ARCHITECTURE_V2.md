# 成长记录与育儿决策支持系统 - 架构 V2

## 系统目标

```
记录成长 → 追踪变化 → 分析原因 → 给出行动建议 → 收集反思与价值观 → 迭代未来建议
```

## 三个核心角色

### 角色 1：私人育儿记录者（事实层）

**职责**：
- 客观记录、结构化整理、分类归档
- 提取变化信号（不做价值判断）
- 把日记转成可检索的"成长档案"

**输出内容**：
- 时间线
- 主题标签
- 可观测行为
- 频率/强度
- 触发条件
- 家长采取的应对

**对应 Agent**：`Recorder Agent`

**输出格式**：
```json
{
  "oneLine": "一句话摘要",
  "events": [
    {
      "type": "sleep",
      "behavior": "夜醒2次，每次约15分钟",
      "trigger": "白天午睡超过2小时",
      "parentResponse": "陪伴安抚，未开灯",
      "frequency": "本周第3次",
      "intensity": "中等（哭泣但可安抚）"
    }
  ],
  "tags": ["睡眠", "夜醒", "午睡过长"],
  "changeSignals": [
    {
      "type": "frequency_increase",
      "description": "夜醒频率较上周增加",
      "comparison": "上周1次 → 本周3次"
    }
  ]
}
```

---

### 角色 2：育儿专家（客观建议层）

**职责**：
- 以循证与儿童发展科学为导向
- 提供专业分析和建议

**输出要求**：
1. 标注建议属于哪类领域
2. 区分三个层次：
   - 🟢 常见发展规律（大多数孩子会经历）
   - 🟡 个体差异（需要观察）
   - 🔴 需要求助专业人士
3. 给出"为什么"与"怎么做"
4. 医疗/心理危机必须提示就医

**对应 Agent**：`Expert Agent`

**输出格式**：
```json
{
  "domain": "睡眠",
  "analysis": {
    "developmentNorm": {
      "level": "green",
      "content": "2岁左右出现睡眠倒退是常见现象，与大脑发育和分离焦虑有关"
    },
    "individualObservation": {
      "level": "yellow",
      "content": "根据近2周记录，孩子的夜醒与午睡时长相关性较高"
    },
    "professionalAlert": null
  },
  "suggestions": [
    {
      "what": "控制午睡时长在1.5小时内",
      "why": "过长午睡会减少夜间睡眠压力，导致入睡困难或夜醒",
      "how": "设置闹钟，午睡1.5小时后轻柔唤醒",
      "evidence": "基于睡眠科学研究",
      "alignsWithValues": true,
      "valueNote": "符合你'尊重生理规律'的原则"
    }
  ],
  "disclaimer": null
}
```

---

### 角色 3：育儿价值观导师（主观澄清层）

**职责**：
- 帮助澄清冲突观点中的取舍依据
- 降低育儿内耗
- 把价值观提炼成可执行的"原则"
- 区分"我的价值观"与"专家共识"

**核心功能**：

#### 3.1 价值观收集

从日常记录和对话中提取家长的价值取向：
```json
{
  "observedTendency": "倾向于给孩子更多自主选择空间",
  "context": "在1月10日的记录中，面对孩子不想穿外套，选择让孩子体验冷而非强制",
  "possiblePrinciple": "在安全范围内，允许孩子体验自然后果",
  "confirmQuestion": "这是否符合你的育儿理念？"
}
```

#### 3.2 冲突调和

当不同建议/观点冲突时：
```json
{
  "conflict": "关于孩子看电视的时间",
  "viewA": {
    "position": "严格限制屏幕时间",
    "rationale": "保护视力和专注力发展",
    "applicableWhen": "日常情况"
  },
  "viewB": {
    "position": "适度允许",
    "rationale": "作为调节工具，给家长喘息空间",
    "applicableWhen": "家长精力不足、孩子生病等特殊情况"
  },
  "synthesis": "两者并非对立，而是适用条件不同。建议制定'日常规则'和'弹性规则'"
}
```

#### 3.3 原则库维护

```json
{
  "principleId": "P001",
  "principle": "在安全边界内最大化孩子的自主权",
  "source": "从1月份的5次记录中提炼",
  "hierarchy": "核心原则",
  "tradeoffs": "当安全与自主冲突时，安全优先",
  "lastUpdated": "2026-01-15",
  "canRevise": true
}
```

**对应 Agent**：`Values Agent`

---

## 完整流程

### 流程 1：日志记录流程

```
用户输入日志
    ↓
┌─────────────────────────────────────────┐
│ Recorder Agent（事实层）                 │
│ - 结构化记录                            │
│ - 提取行为、触发条件、应对方式           │
│ - 检测变化信号（对比历史）               │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│ Expert Agent（专家层）                   │
│ - 分析原因                              │
│ - 区分：规律/个体/需求助                 │
│ - 给出建议（标注领域、为什么、怎么做）    │
│ - 对照价值观原则                         │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│ Values Agent（价值观层）[可选触发]       │
│ - 检测是否有价值观相关内容               │
│ - 提取可能的原则                         │
│ - 标记需要确认的取舍                     │
└─────────────────────────────────────────┘
    ↓
存储 + 展示给用户
```

### 流程 2：对话讨论流程

```
用户发起提问/讨论
    ↓
判断问题类型：
  - 事实查询 → 调用记录者（检索历史）
  - 专业问题 → 调用专家（循证分析）
  - 价值困惑 → 调用导师（澄清取舍）
  - 综合讨论 → 三者协作
    ↓
生成回复（明确标注来源角色）
    ↓
收集用户反馈/反思
    ↓
更新价值观原则库（如有）
```

---

## 数据模型调整

### FactCard 增强

```prisma
model FactCard {
  // ... 现有字段 ...

  // 新增：行为详情
  behaviors       Json     // [{behavior, trigger, parentResponse, frequency, intensity}]

  // 新增：变化信号
  changeSignals   Json?    // [{type, description, comparison}]
}
```

### ExpertAnalysis 增强

```prisma
model ExpertAnalysis {
  // ... 现有字段 ...

  // 新增：领域标注
  domain          String   // 睡眠/情绪/社交/认知/...

  // 新增：三层分析
  developmentNorm Json?    // {level, content} 发展规律
  individualObs   Json?    // {level, content} 个体观察
  professionalAlert String? // 需要求助专业人士的提示

  // 新增：价值观对齐
  valueAlignment  Json?    // [{suggestionIndex, aligns, note}]
}
```

### 新增：ValueExtraction（价值观提取记录）

```prisma
model ValueExtraction {
  id              String   @id @default(cuid())
  sourceType      String   // entry / conversation
  sourceId        String   // Entry ID 或 Conversation ID

  observedTendency String  // 观察到的倾向
  context         String   // 上下文
  possiblePrinciple String // 可能的原则
  status          String   @default("pending") // pending / confirmed / rejected

  confirmedPrincipleId String? // 确认后关联的原则 ID

  createdAt       DateTime @default(now())
}
```

---

## Agent Prompt 调整要点

### Recorder Agent 调整

```markdown
## 新增输出要求

1. **行为详情**：对每个事件记录
   - 具体行为（可观测的）
   - 触发条件（发生前发生了什么）
   - 家长应对（家长做了什么）
   - 频率（本周第几次/与上周对比）
   - 强度（轻/中/重，用客观描述）

2. **变化信号检测**
   - 对比近期记录，检测：
     - 频率变化（增加/减少）
     - 强度变化
     - 新出现的行为
     - 消失的行为
```

### Expert Agent 调整

```markdown
## 新增输出要求

1. **领域标注**：每个建议必须标注属于哪个领域

2. **三层分析**（必须区分）：
   - 🟢 发展规律：大多数这个年龄的孩子会经历的
   - 🟡 个体观察：基于这个孩子的记录发现的特点
   - 🔴 专业提示：需要咨询医生/心理师的情况

3. **建议格式**：
   - What：做什么
   - Why：为什么有效（简要原理）
   - How：具体怎么做
   - Evidence：证据来源（研究/指南/临床经验）

4. **价值观对齐**：
   - 检查建议是否符合用户的价值观原则
   - 如有冲突，明确说明
```

### Values Agent 调整

```markdown
## 核心任务

1. **提取价值观**
   - 从用户的记录和反思中识别价值取向
   - 生成待确认的原则

2. **调和冲突**
   - 当用户面临矛盾建议时，帮助拆解
   - 说明不同建议的适用条件

3. **维护原则库**
   - 把确认的价值观整理成原则
   - 支持用户修订

4. **标注区分**
   - 始终区分"你的价值观"和"专家共识"
   - 允许两者共存但不混淆
```

---

## 界面调整

### 日志展示增强

```
┌─────────────────────────────────────────────┐
│ 📅 1月15日 · 2岁3个月                        │
├─────────────────────────────────────────────┤
│ 📝 记录摘要                                  │
│ 夜醒2次，与午睡过长相关                      │
│                                             │
│ 📊 变化信号                                  │
│ ⚠️ 夜醒频率增加（上周1次→本周3次）           │
│                                             │
│ 🔬 专家分析                                  │
│ [睡眠]                                      │
│ 🟢 发展规律：2岁睡眠倒退是常见现象           │
│ 🟡 个体观察：午睡超2小时时夜醒概率高         │
│                                             │
│ 💡 建议                                      │
│ 1. 控制午睡≤1.5小时                         │
│    为什么：减少夜间睡眠压力                  │
│    怎么做：设闹钟，轻柔唤醒                  │
│    ✓ 符合你的原则「尊重生理规律」            │
│                                             │
│ 💭 价值观提示                                │
│ 检测到你倾向于「观察等待」而非「立即干预」    │
│ [确认为原则] [不是我的风格]                  │
└─────────────────────────────────────────────┘
```

---

## 总结：与 V1 的主要差异

| 维度 | V1 | V2 |
|------|----|----|
| 记录深度 | 事件+标签 | +行为详情+变化信号 |
| 专家输出 | 笼统建议 | 三层分析+循证标注+价值观对齐 |
| 价值观 | 被动存储 | 主动提取+确认+匹配 |
| 用户参与 | 只输入日志 | +确认价值观+修订原则 |
| 对话功能 | 无 | 支持多轮讨论 |
